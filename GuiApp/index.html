<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sim Pedal Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="h-screen flex items-center justify-center bg-gray-500">
    <div class="w-full max-w-7xl bg-gray-700 p-8 rounded-lg shadow-lg">
      <h2 class="text-3xl text-white text-center font-bold underline mb-4">
        Calibration Tool for Sim Pedals
      </h2>

      <!-- Buttons -->
      <div
        class="bg-gray-500 p-3 rounded-lg shadow-lg flex justify-center flex-wrap gap-2 mb-4"
      >
        <button
          id="connect"
          class="py-2.5 px-5 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700"
        >
          Connect
        </button>

        <button
          id="loadBtn"
          class="py-2.5 px-5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700"
        >
          Load
        </button>
        <button
          onclick="send('SAVE')"
          class="py-2.5 px-5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700"
        >
          Save
        </button>
        <button
          onclick="send('RESETCONFIG')"
          id="resetEEPROMBtn"
          class="py-2.5 px-5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700"
        >
          Reset EEPROM
        </button>
        <!-- Calibrate Button -->
        <button
          id="calibrateBtn"
          class="py-2.5 px-5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700"
        >
          Calibrate
        </button>
      </div>

      <!-- Fields + Diagram -->
      <div class="flex gap-6 mt-4">
        <!-- Fields -->
        <div
          class="w-3/5 bg-gray-600 p-4 rounded-lg shadow-lg overflow-auto max-h-[80vh]"
        >
          <!-- Throttle -->
          <div class="">
            <h3 class="text-white font-semibold mb-2">Throttle</h3>

            <div class="flex gap-4">
              <!-- Min -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="throttleMin"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="throttleMin"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Min</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Minimum Value for Throttle
                </p>
              </div>

              <!-- Max -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="throttleMax"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="throttleMax"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Max</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Maximum Value for Throttle
                </p>
              </div>

              <!-- Smoothing -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="alphaThrottle"
                    step="0.01"
                    min="0"
                    max="1"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="alphaThrottle"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Smoothing</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  alphaValue for Smoothening the Throttle Curve (0-0,2),
                  Standard = 0,15
                </p>
              </div>
            </div>
          </div>

          <!-- Brake -->
          <div class="">
            <h3 class="text-white font-semibold mb-2">Brake</h3>

            <div class="flex gap-4">
              <!-- Min -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="brakeMin"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="brakeMin"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Min</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Minimum Value for Brake
                </p>
              </div>

              <!-- Max -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="brakeMax"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="brakeMax"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Max</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Maximum Value for Brake
                </p>
              </div>

              <!-- Smoothing -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="alphaBrake"
                    step="0.01"
                    min="0"
                    max="1"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="alphaBrake"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Smoothing</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  alphaValue for Smoothening the Brake Curve (0-0.2), Standard =
                  0,05
                </p>
              </div>
            </div>
          </div>

          <!-- Clutch -->
          <div class="">
            <h3 class="text-white font-semibold mb-2">Clutch</h3>

            <div class="flex gap-4">
              <!-- Min -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="clutchMin"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="clutchMin"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Min</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Minimum Value for Clutch
                </p>
              </div>

              <!-- Max -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="clutchMax"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="clutchMax"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Max</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Maximum Value for Clutch
                </p>
              </div>

              <!-- Smoothing -->
              <div class="flex-1">
                <div class="relative">
                  <input
                    type="number"
                    id="alphaClutch"
                    step="0.01"
                    min="0"
                    max="1"
                    placeholder=" "
                    class="block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  />
                  <label
                    for="alphaClutch"
                    class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4"
                    >Smoothing</label
                  >
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  alphaValue for Smoothening the Clutch Curve (0-0.2), Standard
                  = 0,10
                </p>
              </div>
            </div>
          </div>

          <!-- Deadzone -->
          <div class="mb-4">
            <h3 class="text-white font-semibold mb-1">Deadzone</h3>
            <div class="relative w-32">
              <input
                type="number"
                id="deadzone"
                placeholder=" "
                class="block rounded-t-lg px-2.5 pb-1.5 pt-2.5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
              />
              <label
                for="deadzone"
                class="absolute text-xs text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-3 scale-75 top-2 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3"
                >Deadzone</label
              >
            </div>
          </div>

          <!-- Pins -->
          <div class="mb-4">
            <h3 class="text-white font-semibold mb-1">Pins</h3>
            <div class="flex gap-4">
              <!-- Throttle Pin -->
              <div class="relative w-32">
                <input
                  type="number"
                  id="pinThrottle"
                  placeholder=" "
                  class="block rounded-t-lg px-2.5 pb-1.5 pt-2.5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                />
                <label
                  for="pinThrottle"
                  class="absolute text-xs text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-3 scale-75 top-2 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3"
                  >Throttle Pin</label
                >
              </div>

              <!-- DT Pin -->
              <div class="relative w-32">
                <input
                  type="number"
                  id="DT_PIN"
                  placeholder=" "
                  class="block rounded-t-lg px-2.5 pb-1.5 pt-2.5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                />
                <label
                  for="DT_PIN"
                  class="absolute text-xs text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-3 scale-75 top-2 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3"
                  >DT Pin</label
                >
              </div>

              <!-- SCK Pin -->
              <div class="relative w-32">
                <input
                  type="number"
                  id="SCK_PIN"
                  placeholder=" "
                  class="block rounded-t-lg px-2.5 pb-1.5 pt-2.5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                />
                <label
                  for="SCK_PIN"
                  class="absolute text-xs text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-3 scale-75 top-2 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3"
                  >SCK Pin</label
                >
              </div>

              <!-- Clutch Pin -->
              <div class="relative w-32">
                <input
                  type="number"
                  id="pinClutch"
                  placeholder=" "
                  class="block rounded-t-lg px-2.5 pb-1.5 pt-2.5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                />
                <label
                  for="pinClutch"
                  class="absolute text-xs text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-3 scale-75 top-2 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3"
                  >Clutch Pin</label
                >
              </div>
            </div>
          </div>

          <div class="justify-center mt-4">
            <button
              id="setAllBtn"
              class="py-2.5 px-5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700"
            >
              Set All
            </button>
          </div>
        </div>

        <!-- Diagram + Raw Values -->
        <div class="w-2/5 bg-gray-600 p-4 rounded-lg shadow-lg">
          <canvas class="bg-gray-700 text-white" id="chart"></canvas>
          <div
            class="mt-4 bg-gray-700 p-2 rounded-lg flex-col justify-around text-white"
            id="rawValues"
          >
            <div class="flex justify-around mb-4">
              <h3>Raw Values</h3>
            </div>
            <div class="flex justify-around">
              <div>Throttle: <span id="throttleRaw">0</span></div>
              <div>Brake: <span id="brakeRaw">0</span></div>
              <div>Clutch: <span id="clutchRaw">0</span></div>
            </div>
          </div>
          <div
            class="hidden mt-4 bg-gray-800 p-2 rounded-lg overflow-auto max-h-40 text-white"
            id="serialMonitor"
          >
            <h3 class="mb-2">Serial Monitor</h3>
            <div id="serialContent" class="text-xs font-mono"></div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        let port, writer;
        let connected = false;
        const connectBtn = document.getElementById("connect");

        let serialBuffer = "";

        // ------------------- Verbindung -------------------
        async function connect() {
          if (!connected) {
            try {
              port = await navigator.serial.requestPort();
              await port.open({ baudRate: 115200 });

              const decoder = new TextDecoderStream();
              port.readable.pipeTo(decoder.writable);
              const reader = decoder.readable.getReader();
              writer = port.writable.getWriter();

              connected = true;
              connectBtn.textContent = "Disconnect";
              connectBtn.classList.remove("bg-green-600");
              connectBtn.classList.add("bg-red-600");

              (async function readLoop() {
                while (connected) {
                  const { value, done } = await reader.read();
                  if (done) break;
                  if (value) parseSerial(value);
                }
              })();
            } catch (err) {
              alert("Fehler beim Verbinden: " + err);
            }
          } else {
            connected = false;
            connectBtn.textContent = "Connect";
            connectBtn.classList.remove("bg-red-600");
            connectBtn.classList.add("bg-green-600");
            if (writer) await writer.close();
            if (port) await port.close();
            writer = null;
            port = null;
          }
        }

        async function send(cmd) {
          if (!writer) return;
          const encoder = new TextEncoder();
          await writer.write(encoder.encode(cmd + "\n"));
        }

        // ------------------- Set All -------------------
        document.getElementById("setAllBtn").onclick = () => {
          const fields = [
            "throttleMin",
            "throttleMax",
            "brakeMin",
            "brakeMax",
            "clutchMin",
            "clutchMax",
            "deadzone",
            "pinClutch",
            "pinThrottle",
            "DT_PIN",
            "SCK_PIN",
            "alphaClutch",
            "alphaThrottle",
            "alphaBrake",
          ];

          fields.forEach((id) => {
            const el = document.getElementById(id);
            let value = el.value;
            send(`SET ${id} ${value}`);
          });
        };

        // ------------------- Chart.js -------------------
        const ctx = document.getElementById("chart").getContext("2d");
        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Throttle",
                data: [],
                borderColor: "green",
                fill: false,
              },
              { label: "Brake", data: [], borderColor: "blue", fill: false },
              { label: "Clutch", data: [], borderColor: "red", fill: false },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            plugins: {
              legend: { labels: { color: "white" } },
            },
            scales: {
              x: {
                ticks: { color: "white" },
                grid: { color: "rgba(255,255,255,0.2)" },
              },
              y: {
                min: 0,
                max: 100,
                ticks: {
                  color: "white",
                  stepSize: 20,
                  callback: (v) => v + "%",
                },
                grid: { color: "rgba(255,255,255,0.2)" },
              },
            },
          },
        });

        function addData(throttle, brake, clutch) {
          // Werte in Prozent umrechnen
          const throttlePct = (throttle / 1023) * 100;
          const brakePct = (brake / 1023) * 100;
          const clutchPct = (clutch / 1023) * 100;

          chart.data.labels.push("");
          chart.data.datasets[0].data.push(throttlePct);
          chart.data.datasets[1].data.push(brakePct);
          chart.data.datasets[2].data.push(clutchPct);

          if (chart.data.labels.length > 100) {
            chart.data.labels.shift();
            chart.data.datasets.forEach((ds) => ds.data.shift());
          }
          chart.update();
        }

        // ------------------- Kalibrierung -------------------
        let calibrating = false;
        let calibData = {
          clutchMin: Infinity,
          clutchMax: -Infinity,
          throttleMin: Infinity,
          throttleMax: -Infinity,
          brakeMin: Infinity,
          brakeMax: -Infinity,
        };
        const calibrateBtn = document.getElementById("calibrateBtn");
        const rawDiv = document.getElementById("rawValues");

        const calibStatus = document.createElement("div");
        calibStatus.className =
          "mt-2 bg-gray-600 p-2 rounded text-white text-sm";
        rawDiv.appendChild(calibStatus);

        function updateCalibStatus() {
          if (!calibrating) {
            calibStatus.innerHTML = "";
            return;
          }
          calibStatus.innerHTML = `
    <strong>Calibration Live:</strong><br>
    Clutch Min: ${calibData.clutchMin}, Max: ${calibData.clutchMax}<br>
    Throttle Min: ${calibData.throttleMin}, Max: ${calibData.throttleMax}<br>
    Brake Min: ${calibData.brakeMin}, Max: ${calibData.brakeMax}
  `;
        }

        calibrateBtn.onclick = () => {
          if (!calibrating) {
            calibrating = true;
            calibData = {
              clutchMin: Infinity,
              clutchMax: -Infinity,
              throttleMin: Infinity,
              throttleMax: -Infinity,
              brakeMin: Infinity,
              brakeMax: -Infinity,
            };
            calibrateBtn.textContent = "Stop Calibrate";
            calibrateBtn.classList.remove("bg-white", "hover:bg-gray-100");
            calibrateBtn.classList.add("bg-yellow-400", "hover:bg-yellow-500");
            updateCalibStatus();
          } else {
            calibrating = false;
            calibrateBtn.textContent = "Calibrate";
            calibrateBtn.classList.remove(
              "bg-yellow-400",
              "hover:bg-yellow-500"
            );
            calibrateBtn.classList.add("bg-white", "hover:bg-gray-100");

            document.getElementById("clutchMin").value = calibData.clutchMin;
            document.getElementById("clutchMax").value = calibData.clutchMax;
            document.getElementById("throttleMin").value =
              calibData.throttleMin;
            document.getElementById("throttleMax").value =
              calibData.throttleMax;
            document.getElementById("brakeMin").value = calibData.brakeMin;
            document.getElementById("brakeMax").value = calibData.brakeMax;

            [
              "clutchMin",
              "clutchMax",
              "throttleMin",
              "throttleMax",
              "brakeMin",
              "brakeMax",
            ].forEach((id) =>
              send(`SET ${id} ${document.getElementById(id).value}`)
            );

            send("SAVE");
            updateCalibStatus();
          }
        };

        // ------------------- Serial Parsing -------------------
        function parseSerial(msg) {
          serialBuffer += msg;
          let lines = serialBuffer.split("\n");
          serialBuffer = lines.pop();

          const serialContent = document.getElementById("serialContent");

          lines.forEach((line) => {
            line = line.trim();
            if (!line) return;

            const lineEl = document.createElement("div");
            lineEl.textContent = line;
            serialContent.insertBefore(lineEl, serialContent.firstChild);

            if (serialContent.children.length > 200) {
              serialContent.removeChild(serialContent.lastChild);
            }

            const values = line.split(",");
            if (values.length === 14) {
              const [
                clutchMin,
                clutchMax,
                throttleMin,
                throttleMax,
                brakeMin,
                brakeMax,
                deadzone,
                pinClutch,
                pinThrottle,
                DT_PIN,
                SCK_PIN,
                alphaClutch,
                alphaThrottle,
                alphaBrake,
              ] = values.map((v, i) => (i < 11 ? parseInt(v) : parseFloat(v)));

              document.getElementById("clutchMin").value = clutchMin;
              document.getElementById("clutchMax").value = clutchMax;
              document.getElementById("throttleMin").value = throttleMin;
              document.getElementById("throttleMax").value = throttleMax;
              document.getElementById("brakeMin").value = brakeMin;
              document.getElementById("brakeMax").value = brakeMax;
              document.getElementById("deadzone").value = deadzone;
              document.getElementById("pinClutch").value = pinClutch;
              document.getElementById("pinThrottle").value = pinThrottle;
              document.getElementById("DT_PIN").value = DT_PIN;
              document.getElementById("SCK_PIN").value = SCK_PIN;
              document.getElementById("alphaClutch").value =
                alphaClutch.toFixed(2);
              document.getElementById("alphaThrottle").value =
                alphaThrottle.toFixed(2);
              document.getElementById("alphaBrake").value =
                alphaBrake.toFixed(2);
            } else if (values.length === 6) {
              const [
                clutchRaw,
                throttleRaw,
                brakeRaw,
                clutch,
                throttle,
                brake,
              ] = values.map((v) => parseInt(v));
              addData(clutch, throttle, brake);
              document.getElementById("clutchRaw").textContent = clutchRaw;
              document.getElementById("throttleRaw").textContent = throttleRaw;
              document.getElementById("brakeRaw").textContent = brakeRaw;

              if (calibrating) {
                if (!isNaN(clutchRaw)) {
                  calibData.clutchMin = Math.min(
                    calibData.clutchMin,
                    clutchRaw
                  );
                  calibData.clutchMax = Math.max(
                    calibData.clutchMax,
                    clutchRaw
                  );
                }
                if (!isNaN(throttleRaw)) {
                  calibData.throttleMin = Math.min(
                    calibData.throttleMin,
                    throttleRaw
                  );
                  calibData.throttleMax = Math.max(
                    calibData.throttleMax,
                    throttleRaw
                  );
                }
                if (!isNaN(brakeRaw)) {
                  calibData.brakeMin = Math.min(calibData.brakeMin, brakeRaw);
                  calibData.brakeMax = Math.max(calibData.brakeMax, brakeRaw);
                }
                updateCalibStatus();
              }
            }
          });
        }

        // ------------------- Button Events -------------------
        connectBtn.onclick = connect;
        document.getElementById("loadBtn").onclick = () => send("LOAD");
        document.querySelector("button[onclick='send(\"SAVE\")']").onclick =
          () => send("SAVE");
      </script>
    </div>
  </body>
</html>
